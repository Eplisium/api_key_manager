<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="projects-header">
                <h2 class="font-semibold">Projects</h2>
                <button class="btn btn-primary btn-sm" onclick="showProjectModal()">New Project</button>
            </div>
            <button class="btn btn-icon w-full mb-4" onclick="showAllKeys()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>
                <span>Show All</span>
                <div class="project-tooltip">Show All Keys</div>
            </button>
        </div>
        <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
            <svg id="theme-toggle-dark-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
            <svg id="theme-toggle-light-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
        </button>
        <div class="theme-separator"></div>
        <div class="projects-container">
            <div id="projects-list"></div>
        </div>
        <div class="theme-separator"></div>
        <button class="clear-all-btn" onclick="confirmClearAllKeys()" title="Clear All Keys">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            <span>Clear All Keys</span>
        </button>
        <button id="toggle-sidebar" class="toggle-sidebar" onclick="toggleSidebar()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        </button>
    </div>

    <div class="main-content" id="main-content">
        <header class="header">
            <h1 class="title">API Key Manager</h1>
            <div class="header-actions">
                <input type="file" id="env-file-input" accept=".env,.json,.yaml,.yml,.properties,.conf,.config" style="display: none" onchange="handleEnvFileUpload(event)">
                <button id="import-env-btn" class="btn btn-secondary" onclick="document.getElementById('env-file-input').click()" style="display: none; margin-right: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Import
                </button>
                <button class="btn btn-primary" onclick="showAddModal()">Add New Key</button>
            </div>
        </header>

        <div id="keys-container" class="keys-grid"></div>

        <!-- Add/Edit Modal -->
        <div id="key-modal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4" id="modal-title">Add New Key</h2>
                <form id="key-form" onsubmit="handleFormSubmit(event)">
                    <input type="hidden" id="key-id">
                    <div class="input-group">
                        <label class="input-label" for="name">Name</label>
                        <input type="text" id="name" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="key">Key</label>
                        <input type="text" id="key" class="input-field" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="description">Description</label>
                        <textarea id="description" class="input-field" rows="3"></textarea>
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="used-with">Used With</label>
                        <input type="text" id="used-with" class="input-field">
                    </div>
                    <div class="input-group">
                        <label class="input-label" for="project">Project</label>
                        <select id="project" class="input-field">
                            <option value="">No Project</option>
                        </select>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn" onclick="hideModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Project Modal -->
        <div id="project-modal" class="modal">
            <div class="modal-content">
                <h2 class="text-xl font-semibold mb-4" id="project-modal-title">New Project</h2>
                <form id="project-form" onsubmit="handleProjectSubmit(event)">
                    <input type="hidden" id="project-id">
                    <div class="input-group">
                        <label class="input-label" for="project-name">Project Name</label>
                        <input type="text" id="project-name" class="input-field" required>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn" onclick="hideProjectModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Post-Import Configuration Modal -->
        <div id="post-import-modal" class="modal">
            <div class="modal-content post-import-modal">
                <div class="import-header">
                    <div class="import-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <h2 class="text-xl font-semibold">Configure Imported Keys</h2>
                    </div>
                    <div class="import-summary">
                        <span id="import-count"></span>
                    </div>
                </div>

                <div class="bulk-actions">
                    <div class="bulk-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        <span class="font-semibold">Bulk Actions</span>
                    </div>
                    <div class="bulk-content">
                        <div class="input-group with-icon">
                            <label class="input-label">Set "Description" for all keys</label>
                            <div class="input-with-button">
                                <input type="text" id="bulk-description" class="input-field" placeholder="Add a description for all keys...">
                                <button class="btn btn-secondary" onclick="applyBulkDescription()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                                    Apply
                                </button>
                                <button class="btn btn-secondary" onclick="clearAllDescriptions()" title="Clear all descriptions">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/></svg>
                                    Clear All
                                </button>
                            </div>
                        </div>
                        <div class="input-group with-icon">
                            <label class="input-label">Set "Used with" for all keys</label>
                            <div class="input-with-button">
                                <input type="text" id="bulk-used-with" class="input-field" placeholder="e.g., AWS, Google Cloud, Azure...">
                                <button class="btn btn-secondary" onclick="applyBulkUsedWith()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="imported-keys-container">
                    <div class="keys-header">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                        <span class="font-semibold">Imported Keys</span>
                    </div>
                    <div class="imported-keys-list" id="imported-keys-list">
                        <!-- Keys will be populated here -->
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn" onclick="hidePostImportModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveImportedKeysConfig()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="copy-success" class="copy-success">Key copied to clipboard!</div>

    <script>
        let isEditMode = false;
        let selectedProject = null;
        let isProjectEditMode = false;
        let draggedKey = null;
        let draggedKeyRect = null;

        async function fetchProjects() {
            try {
                const response = await fetch('/projects');
                const projects = await response.json();
                renderProjects(projects);
                updateProjectSelect(projects);
            } catch (error) {
                console.error('Error fetching projects:', error);
            }
        }

        function renderProjects(projects) {
            const container = document.getElementById('projects-list');
            container.innerHTML = projects.map(project => `
                <div class="project-item ${selectedProject === project.id ? 'active' : ''}" 
                     data-project-id="${project.id}"
                     ondragover="handleDragOver(event)"
                     ondrop="handleDrop(event, ${project.id})"
                     onclick="selectProject(${project.id})">
                    <div class="project-info">
                        <span class="project-name">${project.name}</span>
                        <div class="project-tooltip">${project.name}</div>
                    </div>
                    <div class="project-actions">
                        <button class="btn-icon" onclick="editProject(${project.id}, event)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>
                        <button class="btn-icon destructive" onclick="deleteProject(${project.id}, event)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateProjectSelect(projects) {
            const select = document.getElementById('project');
            select.innerHTML = '<option value="">No Project</option>' + 
                projects.map(project => `<option value="${project.id}">${project.name}</option>`).join('');
        }

        async function fetchKeys() {
            try {
                console.log('Fetching keys...');
                let url = '/keys';
                if (selectedProject !== null) {
                    url += `?project_id=${selectedProject}`;
                } else {
                    url += '?show_all=true';
                }
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch keys');
                }
                const keys = await response.json();
                console.log('Received keys:', keys);
                if (!Array.isArray(keys)) {
                    console.error('Expected array of keys but got:', typeof keys, keys);
                    throw new Error('Invalid response format');
                }
                console.log('Filtered keys:', keys);
                renderKeys(keys);
            } catch (error) {
                console.error('Error fetching keys:', error);
                const container = document.getElementById('keys-container');
                container.innerHTML = 
                    '<div class="error-message">' +
                    'Failed to load keys. Please try refreshing the page.<br>' +
                    'Error: ' + error.message +
                    '</div>';
            }
        }

        function renderKeys(keys) {
            console.log('Rendering keys:', keys);
            const container = document.getElementById('keys-container');
            container.innerHTML = keys.map(key => `
                <div class="key-card" 
                     data-key-id="${key.id}" 
                     draggable="true" 
                     ondragstart="handleDragStart(event, ${key.id})"
                     ondragend="handleDragEnd(event)">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-semibold">${key.name}</h3>
                            <div class="text-xs text-gray-500 mb-1">Project: ${key.project ? key.project.name : 'None'}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyToClipboard('${key.key}')" class="btn-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                <span>Copy</span>
                            </button>
                            <button onclick="editKey(${key.id})" class="btn-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                                <span>Edit</span>
                            </button>
                            <button onclick="deleteKey(${key.id})" class="btn-icon destructive">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">${key.description || ''}</div>
                    <div class="text-sm text-gray-500">Used with: ${key.used_with || 'N/A'}</div>
                </div>
            `).join('');
            
            container.ondragover = handleDragOver;
            container.ondrop = handleDrop;
        }

        function showAllKeys() {
            selectedProject = null;
            localStorage.removeItem('selectedProject');
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('active');
            });
            fetchKeys();
        }

        // Modal operations
        function showProjectModal() {
            isProjectEditMode = false;
            document.getElementById('project-form').reset();
            document.getElementById('project-modal-title').textContent = 'New Project';
            document.getElementById('project-modal').classList.add('show');
        }

        function hideProjectModal() {
            document.getElementById('project-modal').classList.remove('show');
        }

        function showAddModal() {
            isEditMode = false;
            document.getElementById('modal-title').textContent = 'Add New Key';
            document.getElementById('key-form').reset();
            document.getElementById('key-id').value = '';
            document.getElementById('key-modal').classList.add('show');
        }

        function hideModal() {
            document.getElementById('key-modal').classList.remove('show');
        }

        // Form submissions
        async function handleFormSubmit(event) {
            event.preventDefault();
            const formData = {
                name: document.getElementById('name').value,
                key: document.getElementById('key').value,
                description: document.getElementById('description').value,
                used_with: document.getElementById('used-with').value,
                project_id: document.getElementById('project').value || null
            };

            const method = isEditMode ? 'PUT' : 'POST';
            const url = isEditMode 
                ? `/keys/${document.getElementById('key-id').value}`
                : '/keys';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save key');
                }

                hideModal();
                fetchKeys();
            } catch (error) {
                console.error('Error saving key:', error);
                alert(error.message);
            }
        }

        async function editProject(projectId, event) {
            if (event) {
                event.stopPropagation();
            }
            try {
                const projects = await (await fetch('/projects')).json();
                const project = projects.find(p => p.id === projectId);
                if (!project) throw new Error('Project not found');

                document.getElementById('project-id').value = project.id;
                document.getElementById('project-name').value = project.name;
                
                isProjectEditMode = true;
                document.getElementById('project-modal-title').textContent = 'Edit Project';
                document.getElementById('project-modal').classList.add('show');
            } catch (error) {
                console.error('Error fetching project:', error);
                alert('Failed to load project details');
            }
        }

        async function handleProjectSubmit(event) {
            event.preventDefault();
            const formData = {
                name: document.getElementById('project-name').value
            };
            const projectId = document.getElementById('project-id').value;

            try {
                const url = isProjectEditMode ? `/projects/${projectId}` : '/projects';
                const method = isProjectEditMode ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save project');
                }

                hideProjectModal();
                fetchProjects();
            } catch (error) {
                console.error('Error saving project:', error);
                alert(error.message);
            }
        }

        function handleDragStart(event, keyId) {
            draggedKey = keyId;
            const keyCard = event.target;
            draggedKeyRect = keyCard.getBoundingClientRect();
            keyCard.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', keyId);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedKey = null;
            draggedKeyRect = null;
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            // If we're dragging over a project item, just return
            if (event.currentTarget.classList.contains('project-item')) {
                event.currentTarget.classList.add('drag-over');
                return;
            }
            
            const container = document.getElementById('keys-container');
            const cards = Array.from(container.getElementsByClassName('key-card'));
            const draggedElement = document.querySelector('.dragging');
            
            if (!draggedElement) return;
            
            // Only allow reordering within the same project view
            if (selectedProject !== null) {
                const closestCard = findClosestCard(event.clientY, cards.filter(card => !card.classList.contains('dragging')));
                
                if (closestCard) {
                    const rect = closestCard.getBoundingClientRect();
                    const threshold = rect.top + rect.height / 2;
                    
                    if (event.clientY < threshold) {
                        container.insertBefore(draggedElement, closestCard);
                    } else {
                        container.insertBefore(draggedElement, closestCard.nextSibling);
                    }
                }
            }
        }

        function findClosestCard(mouseY, cards) {
            return cards.reduce((closest, card) => {
                const rect = card.getBoundingClientRect();
                const offset = mouseY - rect.top - rect.height / 2;
                
                if (closest === null || Math.abs(offset) < Math.abs(closest.offset)) {
                    return { element: card, offset: offset };
                } else {
                    return closest;
                }
            }, null)?.element;
        }

        async function handleDrop(event, projectId = null) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const keyId = parseInt(event.dataTransfer.getData('text/plain'));
            const container = document.getElementById('keys-container');
            const cards = Array.from(container.getElementsByClassName('key-card'));
            const droppedCard = document.querySelector(`[data-key-id="${keyId}"]`);
            
            try {
                let newPosition = 0;
                
                // If dropping on a project item
                if (projectId !== null) {
                    // Move to end of target project
                    newPosition = -1;  // Special value to indicate "move to end"
                } else {
                    // Reordering within current view
                    if (!droppedCard || !selectedProject) return;
                    newPosition = cards.indexOf(droppedCard);
                    projectId = selectedProject;
                }
                
                const response = await fetch(`/keys/${keyId}/reorder`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        new_position: newPosition,
                        project_id: projectId
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to reorder key');
                }
                
                // If we moved to a different project, switch to that project view
                if (projectId !== selectedProject) {
                    selectProject(projectId);  // This will handle localStorage and UI updates
                }
                
                // Refresh the keys to ensure correct order
                await fetchKeys();
            } catch (error) {
                console.error('Error reordering key:', error);
                // Revert the UI to the original state
                await fetchKeys();
            }
        }

        async function selectProject(projectId) {
            selectedProject = projectId;
            localStorage.setItem('selectedProject', projectId);
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.projectId == projectId) {
                    item.classList.add('active');
                }
            });
            // Show/hide import button based on project selection
            document.getElementById('import-env-btn').style.display = projectId ? 'inline-flex' : 'none';
            fetchKeys();
        }

        document.addEventListener('dragend', () => {
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        });

        async function editKey(keyId, event) {
            if (event) {
                event.stopPropagation();
            }
            try {
                const response = await fetch(`/keys/${keyId}`);
                const key = await response.json();
                
                document.getElementById('key-id').value = key.id;
                document.getElementById('name').value = key.name;
                document.getElementById('key').value = key.key;
                document.getElementById('description').value = key.description || '';
                document.getElementById('used-with').value = key.used_with || '';
                document.getElementById('project').value = key.project ? key.project.id : '';
                
                isEditMode = true;
                document.getElementById('modal-title').textContent = 'Edit Key';
                document.getElementById('key-modal').classList.add('show');
            } catch (error) {
                console.error('Error fetching key:', error);
                alert('Failed to load key details');
            }
        }

        async function deleteKey(keyId, event) {
            if (event) {
                event.stopPropagation();
            }
            if (!confirm('Are you sure you want to delete this key?')) {
                return;
            }

            try {
                const response = await fetch(`/keys/${keyId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete key');
                }

                fetchKeys();
            } catch (error) {
                console.error('Error deleting key:', error);
                alert(error.message);
            }
        }

        async function deleteProject(projectId, event) {
            if (event) {
                event.stopPropagation();
            }
            if (!confirm('Are you sure you want to delete this project and unlink all its keys?')) {
                return;
            }

            try {
                const response = await fetch(`/projects/${projectId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete project');
                }

                if (selectedProject === projectId) {
                    showAllKeys();
                }
                fetchProjects();
            } catch (error) {
                console.error('Error deleting project:', error);
                alert(error.message);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const notification = document.getElementById('copy-success');
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleButton = document.getElementById('toggle-sidebar');
            
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('expanded');
            toggleButton.classList.toggle('rotated');
            
            // Save the state
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            
            if (theme === 'dark') {
                darkIcon.classList.add('hidden');
                lightIcon.classList.remove('hidden');
            } else {
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            }
        }

        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        // Initialize sidebar state
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (sidebarCollapsed) {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const toggleButton = document.getElementById('toggle-sidebar');
            
            sidebar.classList.add('collapsed');
            mainContent.classList.add('expanded');
            toggleButton.classList.add('rotated');
        }

        document.getElementById('theme-toggle').addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');
            await fetchProjects();
            
            // Restore selected project from localStorage
            const savedProject = localStorage.getItem('selectedProject');
            if (savedProject) {
                selectedProject = parseInt(savedProject);
                document.querySelectorAll('.project-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.projectId == selectedProject);
                });
            }
            
            await fetchKeys();
        });

        async function handleEnvFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            const allowedExtensions = ['.env', '.json', '.yaml', '.yml', '.properties', '.conf', '.config'];
            const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
            if (!allowedExtensions.includes(fileExt)) {
                alert(`Invalid file type. Supported formats: ${allowedExtensions.join(', ')}`);
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`/projects/${selectedProject}/import-env`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    showPostImportModal(result.keys);
                } else {
                    alert(result.error || 'Failed to import file');
                }
            } catch (error) {
                console.error('Error importing file:', error);
                alert('Failed to import file');
            }

            // Clear the file input
            event.target.value = '';
        }

        function showPostImportModal(keys) {
            const container = document.getElementById('imported-keys-list');
            document.getElementById('import-count').textContent = `${keys.length} key${keys.length !== 1 ? 's' : ''} imported`;
            
            container.innerHTML = keys.map((key, index) => `
                <div class="imported-key-item" data-key-id="${key.id}">
                    <div class="key-number">${index + 1}</div>
                    <div class="key-content">
                        <div class="key-header">
                            <div class="key-title">
                                <strong class="key-name">${key.name}</strong>
                                <div class="key-value" onclick="copyToClipboard('${key.key}')">
                                    <span class="text-sm text-gray-500">${key.key}</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="key-config">
                            <div class="input-group">
                                <label class="input-label">Description</label>
                                <textarea class="input-field description-field" rows="2" placeholder="Add a description for this key...">${key.description || ''}</textarea>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Used with</label>
                                <input type="text" class="input-field used-with-field" placeholder="e.g., AWS, Google Cloud..." value="${key.used_with || ''}">
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('post-import-modal').classList.add('show');
        }

        function hidePostImportModal() {
            document.getElementById('post-import-modal').classList.remove('show');
            fetchKeys(); // Refresh the keys list
        }

        function applyBulkUsedWith() {
            const bulkValue = document.getElementById('bulk-used-with').value.trim();
            if (!bulkValue) {
                alert('Please enter a value to apply');
                return;
            }
            
            const fields = document.querySelectorAll('.used-with-field');
            fields.forEach(field => {
                field.value = bulkValue;
                // Add a brief highlight effect to show the change
                field.style.backgroundColor = 'var(--hover)';
                setTimeout(() => {
                    field.style.backgroundColor = '';
                }, 300);
            });

            // Show feedback
            const notification = document.createElement('div');
            notification.className = 'bulk-notification';
            notification.textContent = `Applied "${bulkValue}" to ${fields.length} keys`;
            document.querySelector('.bulk-content').appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        function applyBulkDescription() {
            const bulkValue = document.getElementById('bulk-description').value.trim();
            if (!bulkValue) {
                alert('Please enter a description to apply');
                return;
            }
            
            const fields = document.querySelectorAll('.description-field');
            fields.forEach(field => {
                field.value = bulkValue;
                // Add a brief highlight effect to show the change
                field.style.backgroundColor = 'var(--hover)';
                setTimeout(() => {
                    field.style.backgroundColor = '';
                }, 300);
            });

            // Show feedback
            const notification = document.createElement('div');
            notification.className = 'bulk-notification';
            notification.textContent = `Applied description to ${fields.length} keys`;
            document.querySelector('.bulk-content').appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        function clearAllDescriptions() {
            const fields = document.querySelectorAll('.description-field');
            fields.forEach(field => {
                field.value = '';
                // Add a brief highlight effect to show the change
                field.style.backgroundColor = 'var(--hover)';
                setTimeout(() => {
                    field.style.backgroundColor = '';
                }, 300);
            });

            // Show feedback
            const notification = document.createElement('div');
            notification.className = 'bulk-notification';
            notification.textContent = `Cleared descriptions for ${fields.length} keys`;
            document.querySelector('.bulk-content').appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        async function saveImportedKeysConfig() {
            const updates = [];
            document.querySelectorAll('.imported-key-item').forEach(item => {
                const keyId = item.dataset.keyId;
                const description = item.querySelector('.description-field').value;
                const usedWith = item.querySelector('.used-with-field').value;
                
                updates.push(updateKey(keyId, { description, used_with: usedWith }));
            });

            try {
                await Promise.all(updates);
                hidePostImportModal();
            } catch (error) {
                console.error('Error updating imported keys:', error);
                alert('Some keys failed to update. Please try again.');
            }
        }

        async function updateKey(keyId, data) {
            const response = await fetch(`/keys/${keyId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`Failed to update key ${keyId}`);
            }

            return response.json();
        }

        async function confirmClearAllKeys() {
            const projectName = selectedProject ? 
                document.querySelector(`.project-item[data-project-id="${selectedProject}"]`)?.querySelector('.project-name')?.textContent : 
                'all projects';
            
            const message = selectedProject ? 
                `Are you sure you want to delete ALL keys from "${projectName}"?\n\nThis action cannot be undone. There is no built-in way to recover deleted keys.\n\nTip: Consider exporting your keys before deletion for backup.` :
                `Are you sure you want to delete ALL keys from all projects?\n\nThis action cannot be undone. There is no built-in way to recover deleted keys.\n\nTip: Consider exporting your keys before deletion for backup.`;

            if (!confirm(message)) {
                return;
            }

            try {
                const url = selectedProject ? `/projects/${selectedProject}/keys` : '/keys';
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete keys');
                }

                const result = await response.json();

                // Show success notification
                const notification = document.createElement('div');
                notification.className = 'clear-notification';
                notification.textContent = `Deleted ${result.count} keys from ${projectName}`;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);

                // Refresh the keys list
                fetchKeys();
            } catch (error) {
                console.error('Error clearing keys:', error);
                alert('Failed to clear keys. Please try again.');
            }
        }
    </script>

    <style>
        /* All styles have been moved to styles.css */
    </style>
</body>
</html>